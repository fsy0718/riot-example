<riot-calendar>
	<div class="calendar">
		<div class="calendar__head">
			<div class="pure-g">
				<a class="pure-u-1-5" href="javascript:;" onclick={prevMonth} ><</a>
          <div class="pure-u-3-5">
            <span>{curData.title}</span>
          </div>
          <a class="pure-u-1-5" href="javascript:;" onclick={nextMonth}>></a>
			</div>
			<div class="pure-g weeks">
				<div class="pure-u-1-8" each={week in weekTitles}>{week}</div>
			</div>
		</div>
		<div class="calendar__body">
      <div class="pure-g" each={weekdates in curData.weekdates}>
        <div class="pure-u-1-8 {date.range === 0 && 'high' || rangeDates.length > 1 && (date.range === -1 && 'rangeStart' || date.range === 1 && 'rangeEnd') || parseDateClass(date)} " each={date in weekdates}>
          <div class="day {date.valid && 'enable' || 'disable'} {(date.range === -1 || date.range === 1 || date.select === 1) && 'choice'}"  onclick={checkDate}>{date.d}</div>
        </div>
      </div>
		</div>
		<div class="calendar__foot"></div>
		<script>
      tag = this;

      tag.firstDay = Number(tag.opts.firstDay) || 0;
      /*
        opts说明
        autoOk:                 boolean 是否自动保存
        defaultDate:            Date 默认日期
        minDate:                Date 最小日期
        maxDate:                Date 最大日期
        minSelectGap:           Number 最小选择日期
        showOtherMonthDay:      Boolean 是否显示其它月的日期
        isRange:                Boolean 是否为选择范围
        isMultiple:             Boolean 是否为多选
        weekMode:               Boolean 是否固定星期 true 固定
        firstDay:               Number  每周的第一天
        rangeDates:             Array   选中的集合
        selectDates:            Array   选中的日期
      */
      //一些帮助函数
      //天数

      var datesOfMonth = [31,null,31,30,31,30,31,31,30,31,30,31];
      var weekTitles = ['日','一','二','三','四','五','六'];
      var getFirstDateInMonth = function(y,m){
        return new Date(y,m-1,1);
      }
      //是否为闰年
      var isLeapYear = function(y){
        return !(y % 4) && y % 100 || !(y % 400);
      }
      var getDatesInPrevMonth = function(y,m){
        var firstDayInMonth = getFirstDateInMonth(y,m).getDay();
        var dates = 0;
        if(~firstDayInMonth){
          if(firstDayInMonth > tag.firstDay){
            dates = firstDayInMonth - tag.firstDay
          }else if(firstDayInMonth === tag.firstDay){
            dates = 0;
          }else{
            dates = 6 - tag.firstDay + 1 + firstDayInMonth;
          }
        }
        return dates;
      }
      var getDatesInNextMonth = function(y, m){
        return (tag.opts.weekMode ? 6 : getWeeksInMonth(y,m)) * 7 - getDatesInPrevMonth(y,m) - getDatesInMonth(y,m);
      }
      var getDatesInMonth = function(y,m){
        --m;
        return m === 1 ? isLeapYear(y) ? 29 : 28 : datesOfMonth[m];
      }
      var getWeeksInMonth = function(y,m){
        var datesInMonth = getDatesInMonth(y,m) - 7  + getDatesInPrevMonth(y,m);
        return Math.ceil(datesInMonth / 7) + 1 || 0;
      }

      var getWeekTitles = function(){
        tag.weekTitles = weekTitles.slice(tag.firstDay,7).concat(weekTitles.slice(0,tag.firstDay));
      }
      var str2 = function(d){
        return (d > 9 ? ''  : '0') + d;
      }
      //格式化日期
      var formatDate = function(y,m,d){
        if(tag.opts.DateTimeFormat){
          return tag.opts.DateTimeFormat(y,m,d);
        }
        return (y + '-' + str2(m)) + (d ?  ('-' + str2(d)) : '');
      }
      var formatDate2 = function(d){
        if(typeof d === 'string'){
          return d;
        }else if(d){
          return formatDate(d.getFullYear(), d.getMonth() + 1, d.getDate()) 
        }
        return '';
      }
      var getCalendarViewDate = function(y,m){
        var weekNum = tag.opts.weekMode ? 6 : getWeeksInMonth(y,m);
        var datesInPrevMonth = getDatesInPrevMonth(y,m);
        var datesInNextMonth = getDatesInNextMonth(y,m);
        var d = getDatesInMonth(y,m);
        var i = 0;
        var weekDates = [];
        var viewDates = [];
        var y1 = y3 = y, m1 = m3 = m, d1 = d3 = d;
        if(datesInPrevMonth){
          if(m1 === 1){
            --y1;
            m1 = 13;
          }
          --m1;
          d1 = getDatesInMonth(y1,m1);
        }
        if(datesInNextMonth){
          if(m3 === 12){
            ++y2;
            m3 = 0;
          }
          ++m3;
        }

        var rs = formatDate2(tag.rangeDates[0]);
        var re = formatDate2(tag.rangeDates[1]);
        var selectDates = [];
        if(tag.selectDates.length){
          tag.selectDates.forEach(function(date){
            selectDates.push(formatDate2(date));
          })
        }
        var mulSelect = 0;
        var c2 = c3 = 0; 
        while(i < weekNum){
          var j = 0;
          var wd = [];
          while( j < 7){
            var _y, _m, _d,_c = 0;
            if(datesInPrevMonth){
              _y = y1;
              _m = m1;
              _d = d1 - datesInPrevMonth + 1;
              _c = -1;
              --datesInPrevMonth
            }else if(c2 < d){
              _y = y;
              _m = m;
              _d = ++c2; 
            }
            else if(c3 < datesInNextMonth){
              _y = y3;
              _m = m3;
              _d = ++c3;
              _c = 1;
            }
            var _date = new Date(_y, _m - 1, _d);
            /*
              current:    Number 表示月份  -1  前一个月  0  当前月 1 后一个月
              date:       Date  当前日期
              y:          Number 年份
              m:          Number 月份
              d:          Number 日
              w:          Number 星期
              dateformat: String 当前日期格式化字符串
              range:      Number 表示范围选择  -1  表示范围开始  0 表示范围中   1 表示范围结束
              select:     Number 表示是否被选中 0 未选中  1表示选中
              valid:     Number 表示是否可用   0 不可用  1 表示可用
            */
            var r = {
              current: _c,
              date: _date,
              y: _y,
              m: _m,
              d: _d,
              w: _date.getDay(),
              dateformat: formatDate(_y, _m, _d)
            }
            //在范围中
            if(tag.opts.isRange && tag.rangeDates.length){
              if(rs){
                if(rs === r.dateformat){
                  r.range = -1;
                }else if(re){
                  if(r.dateformat === re){
                    r.range = 1;
                  }else if(r.dateformat > rs && r.dateformat < re){
                    r.range = 0;
                  }
                }
              }
            }
            //被选中
            if((tag.opts.isMultiple || !mulSelect) && selectDates.indexOf(r.dateformat) !== -1){
              r.select = 1
              ++mulSelect
            }else{
              r.select = 0;
            }
            if(!tag.minDateStr && !tag.maxDateStr && !r.current){
              r.valid = 1;
            }else if(tag.minDateStr && !r.current){
              if(!tag.maxDateStr){
                if(r.dateformat > tag.minDateStr){
                  r.valid = 1
                }
              }else{
                if(r.dateformat > tag.minDateStr && r.dateformat < tag.maxDateStr){
                  r.valid = 1
                }
              }
            }else{
              r.valid = 0
            }
            j++;
            wd.push(r);
            viewDates.push(r);
          }
          weekDates.push(wd);
          i++;
        }
        return {
          weekDates: weekDates,
          viewDates: viewDates
        }
      }
      //默认日期
      var defaultDate = tag.opts.defaultDate || new Date();
      //当前日历的年月
      var curY = defaultDate.getFullYear();
      var curM = defaultDate.getMonth() + 1;

      var changeView = function(direction){
        curM += direction;
        if(curM < 1){
          curY--;
          curM = 12;
        }
        if(curM > 12){
          curM = 1;
          curY++;
        }
      }

      tag.prevMonth = function(e){
        changeView(-1);
      }
      tag.nextMonth = function(e){
        changeView(1);
      }
      //范围选择
      tag.rangeDates = tag.opts.rangeDates || [];
      tag.minDateStr = formatDate2(tag.opts.minDate || '');
      tag.maxDateStr = formatDate2(tag.opts.maxDate || '');
      tag.selectDates = tag.opts.selectDates || [];
      tag.parseDateClass = function(date){
        if(!date){
          return false;
        }
        if(tag.opts.parseDateClass){
          return tag.opts.parseDateClass(date) || '';
        }
      }
      
      getWeekTitles();

      tag.on('update', function(){
        console.log(tag.rangeDates);
        var _d = getCalendarViewDate(curY, curM);
        tag.curData = {
          title: curY + '年' + curM + '月',
          weekdates: _d.weekDates
        }
      })

      tag.checkDate = function(e){
        var date = e.item.date;
        console.log(e.item.date.dateformat)
        if(tag.opts.isRange){
          if(tag.rangeDates.length === 2 || date.dateformat < formatDate2(tag.rangeDates[0])){
            tag.rangeDates = [date.date]
          }else{
            tag.rangeDates.push(date.date);
          }
        }
      }
      
  </script>
	</div>
</riot-calendar>